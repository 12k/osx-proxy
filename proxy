# !/bin/sh
# SSH SOCKS proxy script for Mac OS X

localport=`jot -r 1 2000 65000`
# Set PROXY_USER and PROXY_HOST somewhere in sourced path
# ie enter following info into .bashrc or .zshrc or a more private auth file
# =start_example
#
# export PROXY_USER='vader'
# export PROXY_HOST='thedeathstar'
#
# =end_example
#
# If choosing not to set credentials as Environmental Variables, replace the values below for $PROXY_USER and $PROXY_HOST with genuine credentials.
# ie 
# remoteuser='vader'
# remoteproxy='thedeathstar'
#
remoteuser=$PROXY_USER
remoteproxy=$PROXY_HOST
remoteport="22"

usage(){
echo ""
echo "Usage: proxy [on|off|killall]"
echo "Proxy is a proxy settings toggle script for OSX"
echo "Proxy initiates an SSH tunnel and then enables a Socks proxy"
}

unknown_input(){
echo "Unknown input, try again with different term"
}

proxy_on(){

  echo "Listening on localhost:$localport. Modifying network settings.."
  sudo networksetup -setsocksfirewallproxy Wi-Fi 127.0.0.1 $localport off
  echo "Starting SSH session. Will run in background for 1 day."
  ssh -f -p $remoteport -D $localport $remoteuser@$remoteproxy sleep 1d
}

proxy_off(){

  echo "Disabling proxy in network settings."
  sudo networksetup -setsocksfirewallproxystate Wi-Fi off
  echo "Done!"
}

kill_all(){

  pids=`ps -A | grep "ssh -f" | grep "sleep" | awk '{print $1}'`
  echo "Killing all running proxy connections."
  for pid in $pids
    do
  `kill -9 $pid`
  done
}
case $1 in
"on")
  proxy_on
  ;;
"off")
  proxy_off
  ;;
"killall")
  kill_all
  ;;
"")
  # add toggle ability
  unknown_input
  usage
  ;;
*)
  unknown_input
  usage
  ;;
esac
